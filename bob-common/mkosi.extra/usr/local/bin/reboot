#!/bin/bash
# Gracefully shutdown services before rebooting

REBOOT_LOCK="/tmp/.system_rebooting"

# Check for force flag
if [[ "$1" == "--force" ]] || [[ "$1" == "-f" ]]; then
    rm -f "$REBOOT_LOCK"
    echo "Force rebooting system..."
    /usr/bin/systemctl reboot --force 2>/dev/null
    exit 0
fi

# Check if reboot is already in progress
if [[ -f "$REBOOT_LOCK" ]]; then
    echo "System is already rebooting. Use 'reboot --force' to force."
    exit 1
fi

# Create lock file
touch "$REBOOT_LOCK"

echo "Initiating reboot sequence..."

# Stop services gracefully in reverse dependency order
echo "Stopping services..."

# Stop highest-level services first
systemctl stop searcher-container.service 2>/dev/null || true
systemctl stop cvm-reverse-proxy.service 2>/dev/null || true
systemctl stop ssh-pubkey-server.service 2>/dev/null || true

# Stop blockchain services
systemctl stop lighthouse.service 2>/dev/null || true

# Stop monitoring/logging
systemctl stop delay-pipe.service 2>/dev/null || true

# Stop firewall and network
systemctl stop searcher-firewall.service 2>/dev/null || true
systemctl stop dropbear.service 2>/dev/null || true

# Give services a moment to clean up
sleep 2

# Unmount persistent storage
echo "Unmounting persistent storage..."
umount /persistent 2>/dev/null || true

# Sync all filesystems
echo "Syncing filesystems..."
sync

# Give kernel a moment to finish pending writes
sleep 1

echo "Rebooting system..."
/usr/bin/systemctl reboot 2>/dev/null
exit 0
