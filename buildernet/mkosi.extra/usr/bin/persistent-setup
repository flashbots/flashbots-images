#!/bin/bash
set -eu -o pipefail

source /usr/bin/helper-functions.sh

# Parse LUN from first argument
if [[ $# -lt 1 ]]; then
  echo "Usage: $(basename "$0") <LUN>" >&2
  exit 1
fi

LUN="$1"

function find_target_device {
  local lun="$1"

  # Try SCSI by-path
  local scsi_candidates=(/dev/disk/by-path/*scsi-0:0:0:${lun})
  if [[ -e "${scsi_candidates[0]}" ]]; then
    readlink -f "${scsi_candidates[0]}"
    return 0
  fi

  # Try NVMe by-path (data namespace = LUN + 2)
  local nsid=$((lun+2))
  local nvme_candidates=(/dev/disk/by-path/*-nvme-${nsid})
  if [[ -e "${nvme_candidates[0]}" ]]; then
    readlink -f "${nvme_candidates[0]}"
    return 0
  fi

  return 1
}

INTERVAL=2

log "persistent-setup: Waiting for device with LUN ${LUN} to appear..."

while true; do
  if TARGET_DEVICE=$(find_target_device "$LUN"); then
    log "persistent-setup: Found device ${TARGET_DEVICE} for LUN ${LUN}"
    break
  fi

  sleep $INTERVAL
done

# Ensure we got a real block device, not a glob or missing path
if [[ ! -b "$TARGET_DEVICE" ]]; then
  log "persistent-setup: Resolved path is not a block device: ${TARGET_DEVICE}"
  exit 1
fi

LUKS_UUID=""
BLOCK_UUID=""

if cryptsetup isLuks "$TARGET_DEVICE"; then
  log "persistent-setup: Device ${TARGET_DEVICE} for LUN ${LUN} is already LUKS encrypted, attempting to unlock"

  LUKS_UUID=$(cryptsetup luksUUID "$TARGET_DEVICE")

  # Try to open the device (TPM should unlock it automatically)
  if cryptsetup open "$TARGET_DEVICE" persistent; then
    log "persistent-setup: Successfully unlocked encrypted device"
    BLOCK_UUID=$(blkid -s UUID -o value /dev/mapper/persistent)
  else
    log "persistent-setup: Failed to unlock device ${TARGET_DEVICE}"
    exit 1
  fi
else
  log "persistent-setup: Device ${TARGET_DEVICE} for LUN ${LUN} is not encrypted, performing initial setup"

  TEMP_ENC_PASS=$(openssl rand -hex 64)
  echo -n "$TEMP_ENC_PASS" | cryptsetup luksFormat --type luks2 "$TARGET_DEVICE"
  systemd-cryptenroll --tpm2-device=auto --tpm2-pcrs=11 "$TARGET_DEVICE" --unlock-key-file=<(echo -n "$TEMP_ENC_PASS")
  # Allow only unlocking with TPM
  systemd-cryptenroll --wipe-slot=0 "$TARGET_DEVICE"
  unset TEMP_ENC_PASS
  cryptsetup open "$TARGET_DEVICE" persistent
  mkfs.ext4 /dev/mapper/persistent

  LUKS_UUID=$(cryptsetup luksUUID "$TARGET_DEVICE")
  BLOCK_UUID=$(blkid -s UUID -o value /dev/mapper/persistent)
fi

# Ensure crypttab and fstab are configured
echo "persistent UUID=${LUKS_UUID} - tpm2-device=auto,tpm2-pcrs=11" > /etc/crypttab
echo "UUID=${BLOCK_UUID} /var/lib/persistent ext4 defaults,nosuid,noexec,noatime,x-systemd.mkdir,x-systemd.automount 0 2" > /etc/fstab

systemctl daemon-reload
systemctl start systemd-cryptsetup@persistent.service
systemctl start var-lib-persistent.automount

log "persistent-setup: Completed setup for LUN ${LUN} on device ${TARGET_DEVICE}"
